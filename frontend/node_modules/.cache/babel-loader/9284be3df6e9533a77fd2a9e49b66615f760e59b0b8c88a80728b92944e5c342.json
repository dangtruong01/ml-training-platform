{"ast":null,"code":"import React,{useState,useEffect}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function Annotate(){const[files,setFiles]=useState([]);const[previews,setPreviews]=useState([]);const[annotatedResults,setAnnotatedResults]=useState([]);const[annotationType,setAnnotationType]=useState('detection');const[isLoading,setIsLoading]=useState(false);const[processingProgress,setProcessingProgress]=useState({current:0,total:0});const[batchId,setBatchId]=useState(null);// GroundingDINO specific state\nconst[groundingDinoPrompts,setGroundingDinoPrompts]=useState('scratch, dent, dirt');const[confidenceThreshold,setConfidenceThreshold]=useState(0.3);const[groundingDinoAvailable,setGroundingDinoAvailable]=useState(false);// Check GroundingDINO availability on component mount\nuseEffect(()=>{checkGroundingDinoStatus();},[]);const checkGroundingDinoStatus=async()=>{try{const response=await fetch('/grounding-dino-status');const data=await response.json();setGroundingDinoAvailable(data.available);}catch(error){console.error('Error checking GroundingDINO status:',error);setGroundingDinoAvailable(false);}};const handleFileChange=e=>{const selectedFiles=Array.from(e.target.files);setFiles(selectedFiles);// Create previews for all selected files\nconst newPreviews=selectedFiles.map(file=>({file,url:URL.createObjectURL(file),name:file.name}));setPreviews(newPreviews);setAnnotatedResults([]);// Reset results when new files are selected\n};const handleAnnotate=async()=>{if(files.length===0){alert(\"Please select at least one file first.\");return;}setIsLoading(true);setProcessingProgress({current:0,total:files.length});setAnnotatedResults([]);// Generate unique batch ID\nconst newBatchId=\"batch_\".concat(Date.now(),\"_\").concat(Math.random().toString(36).substr(2,9));setBatchId(newBatchId);if(annotationType==='grounding-dino'){await handleGroundingDinoAnnotation(newBatchId);}else{await handleTraditionalAnnotation(newBatchId);}};const handleGroundingDinoAnnotation=async newBatchId=>{try{const formData=new FormData();files.forEach(file=>formData.append('files',file));formData.append('prompts',groundingDinoPrompts);formData.append('confidence_threshold',confidenceThreshold);const response=await fetch('/grounding-dino-batch',{method:'POST',body:formData});if(response.ok){const data=await response.json();const results=data.results.map(result=>({originalName:result.filename,success:result.status==='success',annotatedUrl:result.status==='success'?\"data:image/jpeg;base64,\".concat(result.image_base64):null,error:result.status!=='success'?result.message:null,detections:result.detections||[],total_detections:result.total_detections||0,yolo_annotations:result.yolo_annotations}));setAnnotatedResults(results);}else{throw new Error('GroundingDINO batch annotation failed');}}catch(error){console.error('GroundingDINO annotation error:',error);alert('GroundingDINO annotation failed. Please try again.');}finally{setIsLoading(false);setProcessingProgress({current:0,total:0});}};const handleTraditionalAnnotation=async newBatchId=>{const endpointMap={'detection':'/pre-annotate-detect','segmentation':'/pre-annotate-segment','sam2-detection':'/pre-annotate-sam2-detect','sam2-segmentation':'/pre-annotate-sam2-segment'};const endpoint=endpointMap[annotationType]||'/pre-annotate-detect';const results=[];try{for(let i=0;i<files.length;i++){const file=files[i];setProcessingProgress({current:i+1,total:files.length});const formData=new FormData();formData.append(\"file\",file);formData.append(\"batch_id\",newBatchId);// Add batch ID for caching\ntry{const response=await fetch(endpoint,{method:\"POST\",body:formData});if(response.ok){const imageBlob=await response.blob();results.push({originalName:file.name,annotatedUrl:URL.createObjectURL(imageBlob),success:true});}else{results.push({originalName:file.name,success:false,error:\"\".concat(annotationType,\" annotation failed\")});}}catch(error){console.error(\"Error processing \".concat(file.name,\":\"),error);results.push({originalName:file.name,success:false,error:\"Processing error\"});}}setAnnotatedResults(results);}catch(error){console.error(\"Error during batch annotation:\",error);alert(\"An error occurred during batch annotation.\");}finally{setIsLoading(false);setProcessingProgress({current:0,total:0});}};const handleDownloadZip=async()=>{const successfulResults=annotatedResults.filter(result=>result.success);if(successfulResults.length===0){alert(\"No successful annotations to download.\");return;}try{const response=await fetch(\"/download-batch-zip/\".concat(batchId),{method:'POST'});if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.style.display='none';a.href=url;a.download=\"annotated_\".concat(annotationType,\"_batch.zip\");document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);document.body.removeChild(a);}else{throw new Error('Failed to download zip file');}}catch(error){console.error('Error downloading zip:',error);alert('Failed to download zip file. Please try again.');}};const handleExportYoloDataset=async()=>{const groundingDinoResults=annotatedResults.filter(result=>result.success&&result.yolo_annotations);if(groundingDinoResults.length===0){alert(\"No GroundingDINO results to export.\");return;}try{const formData=new FormData();formData.append('annotation_results',JSON.stringify(groundingDinoResults));formData.append('dataset_name',\"grounding_dino_\".concat(Date.now()));const response=await fetch('/grounding-dino-export-yolo',{method:'POST',body:formData});if(response.ok){const data=await response.json();alert(\"YOLO dataset exported successfully: \".concat(data.dataset_name));}else{throw new Error('Failed to export dataset');}}catch(error){console.error('Error exporting dataset:',error);alert('Failed to export YOLO dataset.');}};const renderAnnotationTypeSelector=()=>/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83C\\uDFAF Annotation Method\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'10px'},children:[/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',padding:'10px',border:'2px solid #e2e8f0',borderRadius:'8px',backgroundColor:annotationType==='detection'?'#dbeafe':'white',borderColor:annotationType==='detection'?'#3b82f6':'#e2e8f0',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"detection\",checked:annotationType==='detection',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83D\\uDCE6 OpenCV Detection\"})]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',padding:'10px',border:'2px solid #e2e8f0',borderRadius:'8px',backgroundColor:annotationType==='segmentation'?'#dbeafe':'white',borderColor:annotationType==='segmentation'?'#3b82f6':'#e2e8f0',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"segmentation\",checked:annotationType==='segmentation',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u2702\\uFE0F OpenCV Segmentation\"})]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',padding:'10px',border:'2px solid #e2e8f0',borderRadius:'8px',backgroundColor:annotationType==='sam2-detection'?'#dbeafe':'white',borderColor:annotationType==='sam2-detection'?'#3b82f6':'#e2e8f0',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"sam2-detection\",checked:annotationType==='sam2-detection',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83C\\uDFAF SAM2 Detection\"})]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',padding:'10px',border:'2px solid #e2e8f0',borderRadius:'8px',backgroundColor:annotationType==='sam2-segmentation'?'#dbeafe':'white',borderColor:annotationType==='sam2-segmentation'?'#3b82f6':'#e2e8f0',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"sam2-segmentation\",checked:annotationType==='sam2-segmentation',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83D\\uDD2A SAM2 Segmentation\"})]}),groundingDinoAvailable&&/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',padding:'10px',border:'2px solid #10b981',borderRadius:'8px',backgroundColor:annotationType==='grounding-dino'?'#d1fae5':'white',borderColor:annotationType==='grounding-dino'?'#10b981':'#10b981',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"grounding-dino\",checked:annotationType==='grounding-dino',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u2728 GroundingDINO (AI-Powered)\"})]})]}),!groundingDinoAvailable&&/*#__PURE__*/_jsx(\"div\",{style:{marginTop:'10px',padding:'10px',backgroundColor:'#fef3c7',border:'1px solid #f59e0b',borderRadius:'4px',fontSize:'14px'},children:\"\\u26A0\\uFE0F GroundingDINO not available. Please install dependencies to use AI-powered annotation.\"})]});const renderGroundingDinoOptions=()=>{if(annotationType!=='grounding-dino')return null;return/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px',padding:'20px',backgroundColor:'#f0fdf4',border:'1px solid #10b981',borderRadius:'8px'},children:[/*#__PURE__*/_jsx(\"h4\",{style:{margin:'0 0 15px 0',color:'#059669'},children:\"\\u2728 GroundingDINO Settings\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'15px'},children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Defect Prompts (comma-separated):\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:groundingDinoPrompts,onChange:e=>setGroundingDinoPrompts(e.target.value),placeholder:\"e.g., scratch, dent, dirt, corrosion, crack\",style:{width:'100%',padding:'8px',border:'1px solid #d1d5db',borderRadius:'4px',fontSize:'14px'}}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'12px',color:'#6b7280',marginTop:'5px'},children:\"Describe the defects you want to detect. Be specific (e.g., \\\"scratch on metal surface\\\").\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'15px'},children:[/*#__PURE__*/_jsxs(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:[\"Confidence Threshold: \",confidenceThreshold]}),/*#__PURE__*/_jsx(\"input\",{type:\"range\",min:\"0.1\",max:\"0.9\",step:\"0.1\",value:confidenceThreshold,onChange:e=>setConfidenceThreshold(parseFloat(e.target.value)),style:{width:'200px'}}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'12px',color:'#6b7280',marginTop:'5px'},children:\"Lower values detect more objects but may include false positives.\"})]})]});};const renderResults=()=>{if(annotatedResults.length===0)return null;const successfulResults=annotatedResults.filter(result=>result.success);const failedResults=annotatedResults.filter(result=>!result.success);return/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'30px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83D\\uDCCA Annotation Results\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:'10px'},children:[successfulResults.length>0&&/*#__PURE__*/_jsx(\"button\",{onClick:handleDownloadZip,style:{backgroundColor:'#059669',color:'white',padding:'8px 16px',border:'none',borderRadius:'4px',cursor:'pointer'},children:\"\\uD83D\\uDCE5 Download ZIP\"}),annotationType==='grounding-dino'&&successfulResults.some(r=>r.yolo_annotations)&&/*#__PURE__*/_jsx(\"button\",{onClick:handleExportYoloDataset,style:{backgroundColor:'#7c3aed',color:'white',padding:'8px 16px',border:'none',borderRadius:'4px',cursor:'pointer'},children:\"\\uD83D\\uDCE6 Export YOLO Dataset\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))',gap:'20px',marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"div\",{style:{padding:'15px',backgroundColor:'#dcfce7',border:'1px solid #86efac',borderRadius:'8px'},children:/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'18px',fontWeight:'bold',color:'#059669'},children:[\"\\u2705 Successful: \",successfulResults.length]})}),/*#__PURE__*/_jsx(\"div\",{style:{padding:'15px',backgroundColor:'#fee2e2',border:'1px solid #fca5a5',borderRadius:'8px'},children:/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'18px',fontWeight:'bold',color:'#dc2626'},children:[\"\\u274C Failed: \",failedResults.length]})})]}),/*#__PURE__*/_jsx(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(400px, 1fr))',gap:'20px'},children:annotatedResults.map((result,index)=>/*#__PURE__*/_jsxs(\"div\",{style:{border:'1px solid #e2e8f0',borderRadius:'8px',padding:'15px',backgroundColor:result.success?'#f9fafb':'#fef2f2'},children:[/*#__PURE__*/_jsx(\"h4\",{style:{margin:'0 0 10px 0'},children:result.originalName}),result.success?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"img\",{src:result.annotatedUrl,alt:\"Annotated \".concat(result.originalName),style:{width:'100%',borderRadius:'4px',marginBottom:'10px'}}),result.detections&&/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'14px',color:'#6b7280'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Detections:\"}),\" \",result.total_detections||result.detections.length,result.detections.map((detection,idx)=>/*#__PURE__*/_jsxs(\"div\",{style:{marginLeft:'10px',fontSize:'12px'},children:[\"\\u2022 \",detection.class,\": \",(detection.confidence*100).toFixed(1),\"%\"]},idx))]})]}):/*#__PURE__*/_jsxs(\"div\",{style:{color:'#dc2626'},children:[\"Error: \",result.error]})]},index))})]});};return/*#__PURE__*/_jsxs(\"div\",{style:{padding:'20px',maxWidth:'1200px',margin:'0 auto'},children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\uD83C\\uDFF7\\uFE0F Image Annotation\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'10px',fontSize:'16px',fontWeight:'bold'},children:\"\\uD83D\\uDCC1 Select Images:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",multiple:true,accept:\"image/*\",onChange:handleFileChange,style:{padding:'10px',border:'2px dashed #d1d5db',borderRadius:'8px',width:'100%',cursor:'pointer'}}),files.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'10px',fontSize:'14px',color:'#059669'},children:[\"\\u2705 \",files.length,\" image(s) selected\"]})]}),renderAnnotationTypeSelector(),renderGroundingDinoOptions(),/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:'30px'},children:/*#__PURE__*/_jsx(\"button\",{onClick:handleAnnotate,disabled:files.length===0||isLoading,style:{backgroundColor:files.length===0||isLoading?'#9ca3af':'#1e3a8a',color:'white',padding:'12px 24px',border:'none',borderRadius:'8px',fontSize:'16px',cursor:files.length===0||isLoading?'not-allowed':'pointer'},children:isLoading?\"\\uD83D\\uDD04 Processing... (\".concat(processingProgress.current,\"/\").concat(processingProgress.total,\")\"):'ðŸš€ Start Annotation'})}),renderResults()]});}export default Annotate;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}