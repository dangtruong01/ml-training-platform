{"ast":null,"code":"import React,{useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function Annotate(){const[files,setFiles]=useState([]);const[previews,setPreviews]=useState([]);const[annotatedResults,setAnnotatedResults]=useState([]);const[annotationType,setAnnotationType]=useState('detection');const[isLoading,setIsLoading]=useState(false);const[processingProgress,setProcessingProgress]=useState({current:0,total:0});const[batchId,setBatchId]=useState(null);const handleFileChange=e=>{const selectedFiles=Array.from(e.target.files);setFiles(selectedFiles);// Create previews for all selected files\nconst newPreviews=selectedFiles.map(file=>({file,url:URL.createObjectURL(file),name:file.name}));setPreviews(newPreviews);setAnnotatedResults([]);// Reset results when new files are selected\n};const handleAnnotate=async()=>{if(files.length===0){alert(\"Please select at least one file first.\");return;}setIsLoading(true);setProcessingProgress({current:0,total:files.length});setAnnotatedResults([]);// Generate unique batch ID\nconst newBatchId=\"batch_\".concat(Date.now(),\"_\").concat(Math.random().toString(36).substr(2,9));setBatchId(newBatchId);const endpointMap={'detection':'/pre-annotate-detect','segmentation':'/pre-annotate-segment','sam2-detection':'/pre-annotate-sam2-detect','sam2-segmentation':'/pre-annotate-sam2-segment'};const endpoint=endpointMap[annotationType]||'/pre-annotate-detect';const results=[];try{for(let i=0;i<files.length;i++){const file=files[i];setProcessingProgress({current:i+1,total:files.length});const formData=new FormData();formData.append(\"file\",file);formData.append(\"batch_id\",newBatchId);// Add batch ID for caching\ntry{const response=await fetch(endpoint,{method:\"POST\",body:formData});if(response.ok){const imageBlob=await response.blob();results.push({originalName:file.name,annotatedUrl:URL.createObjectURL(imageBlob),success:true});}else{results.push({originalName:file.name,success:false,error:\"\".concat(annotationType,\" annotation failed\")});}}catch(error){console.error(\"Error processing \".concat(file.name,\":\"),error);results.push({originalName:file.name,success:false,error:\"Processing error\"});}}setAnnotatedResults(results);}catch(error){console.error(\"Error during batch annotation:\",error);alert(\"An error occurred during batch annotation.\");}finally{setIsLoading(false);setProcessingProgress({current:0,total:0});}};const handleDownloadZip=async()=>{const successfulResults=annotatedResults.filter(result=>result.success);if(successfulResults.length===0){alert(\"No successfully annotated images to download.\");return;}if(!batchId){alert(\"Batch ID not found. Please process images first.\");return;}try{console.log(\"Downloading zip for batch: \".concat(batchId));// Use the new cached download endpoint (no reprocessing!)\nconst response=await fetch(\"/download-batch-zip/\".concat(batchId),{method:'POST'});if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=\"annotated_\".concat(annotationType,\"_batch.zip\");document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);document.body.removeChild(a);console.log(\"✅ Zip downloaded successfully using cached results!\");}else{const errorText=await response.text();console.error(\"Download failed:\",errorText);alert(\"Failed to create zip file: \".concat(errorText));}}catch(error){console.error(\"Error downloading zip:\",error);alert(\"An error occurred while creating the zip file.\");}};return/*#__PURE__*/_jsxs(\"div\",{style:{padding:'20px'},children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Pre-annotate Images\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"file\",multiple:true,onChange:handleFileChange,accept:\"image/*\",style:{marginBottom:'10px',display:'block'}}),files.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'10px',fontSize:'14px',color:'#666'},children:[\"\\uD83D\\uDCC1 \",files.length,\" file\",files.length>1?'s':'',\" selected\"]})]}),previews.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Selected Images:\"}),/*#__PURE__*/_jsx(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:'15px',marginBottom:'20px'},children:previews.map((preview,index)=>/*#__PURE__*/_jsxs(\"div\",{style:{textAlign:'center'},children:[/*#__PURE__*/_jsx(\"img\",{src:preview.url,alt:preview.name,style:{width:'100%',height:'120px',objectFit:'cover',border:'2px solid #ddd',borderRadius:'8px'}}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'12px',marginTop:'5px',wordBreak:'break-all'},children:preview.name})]},index))})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Select Annotation Method:\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'15px'},children:[/*#__PURE__*/_jsx(\"h5\",{style:{margin:'5px 0',color:'#666'},children:\"\\uD83D\\uDD27 OpenCV (Traditional)\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:'15px',alignItems:'center',flexWrap:'wrap',marginLeft:'20px'},children:[/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"detection\",checked:annotationType==='detection',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsxs(\"span\",{children:[\"\\uD83C\\uDFAF \",/*#__PURE__*/_jsx(\"strong\",{children:\"Detection\"}),\" - Basic edge detection with bounding boxes\"]})]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"segmentation\",checked:annotationType==='segmentation',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsxs(\"span\",{children:[\"\\u2702\\uFE0F \",/*#__PURE__*/_jsx(\"strong\",{children:\"Segmentation\"}),\" - Basic contour detection\"]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'15px'},children:[/*#__PURE__*/_jsx(\"h5\",{style:{margin:'5px 0',color:'#059669'},children:\"\\uD83E\\uDD16 SAM2 (AI-Powered) - Recommended\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:'15px',alignItems:'center',flexWrap:'wrap',marginLeft:'20px'},children:[/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"sam2-detection\",checked:annotationType==='sam2-detection',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsxs(\"span\",{children:[\"\\uD83C\\uDFAF \",/*#__PURE__*/_jsx(\"strong\",{children:\"SAM2 Detection\"}),\" - Single main object detection (best for primary metallic parts)\"]})]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',cursor:'pointer'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",value:\"sam2-segmentation\",checked:annotationType==='sam2-segmentation',onChange:e=>setAnnotationType(e.target.value),style:{marginRight:'8px'}}),/*#__PURE__*/_jsxs(\"span\",{children:[\"\\u2702\\uFE0F \",/*#__PURE__*/_jsx(\"strong\",{children:\"SAM2 Segmentation\"}),\" - Precise AI masks (\\u26A0\\uFE0F Slow on CPU: 30-60s/image)\"]})]})]})]}),/*#__PURE__*/_jsx(\"div\",{style:{backgroundColor:annotationType.startsWith('sam2')?'#f0fdf4':'#f8fafc',border:\"1px solid \".concat(annotationType.startsWith('sam2')?'#059669':'#e2e8f0'),borderRadius:'6px',padding:'10px',fontSize:'14px',marginTop:'10px'},children:annotationType.startsWith('sam2')?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDE80 SAM2 Benefits:\"}),\" Better accuracy with metallic objects, works with any lighting/background, AI-powered precision. First run will download the model (~40MB for CPU-optimized version).\",/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"strong\",{children:\"\\u26A0\\uFE0F Performance:\"}),\" GPU: ~2-5 sec/image | CPU: ~10-30 sec/image (auto-optimized)\"]}):/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u26A1 OpenCV:\"}),\" Very fast (~0.5-2 sec/image) but may struggle with complex backgrounds or lighting variations.\"]})})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'30px'},children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleAnnotate,disabled:files.length===0||isLoading,style:{backgroundColor:files.length===0||isLoading?'#ccc':'#1e3a8a',color:'white',padding:'12px 24px',border:'none',borderRadius:'6px',cursor:files.length===0||isLoading?'not-allowed':'pointer',fontSize:'16px',marginRight:'15px'},children:isLoading?\"Processing \".concat(annotationType,\"...\"):\"Start Batch \".concat(annotationType)}),annotatedResults.length>0&&/*#__PURE__*/_jsxs(\"button\",{onClick:handleDownloadZip,style:{backgroundColor:'#059669',color:'white',padding:'12px 24px',border:'none',borderRadius:'6px',cursor:'pointer',fontSize:'16px'},children:[\"\\uD83D\\uDCE6 Download Zip (\",annotatedResults.filter(r=>r.success).length,\" files)\"]})]}),isLoading&&/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'20px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'14px',marginBottom:'8px'},children:[\"Processing: \",processingProgress.current,\" / \",processingProgress.total]}),/*#__PURE__*/_jsx(\"div\",{style:{width:'100%',backgroundColor:'#f0f0f0',borderRadius:'8px',height:'8px'},children:/*#__PURE__*/_jsx(\"div\",{style:{width:\"\".concat(processingProgress.current/processingProgress.total*100,\"%\"),backgroundColor:'#1e3a8a',height:'8px',borderRadius:'8px',transition:'width 0.3s ease'}})})]}),annotatedResults.length>0&&/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83D\\uDCCB Processing Results\"}),/*#__PURE__*/_jsx(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))',gap:'20px'},children:annotatedResults.map((result,index)=>/*#__PURE__*/_jsxs(\"div\",{style:{border:\"2px solid \".concat(result.success?'#059669':'#dc2626'),borderRadius:'8px',padding:'15px'},children:[/*#__PURE__*/_jsxs(\"h4\",{style:{margin:'0 0 10px 0',color:result.success?'#059669':'#dc2626'},children:[result.success?'✅':'❌',\" \",result.originalName]}),result.success?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"img\",{src:result.annotatedUrl,alt:\"Annotated \".concat(result.originalName),style:{width:'100%',height:'auto',borderRadius:'6px'}}),/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'12px',marginTop:'5px',color:'#666'},children:[annotationType==='detection'&&'Objects detected with OpenCV bounding boxes',annotationType==='segmentation'&&'Objects segmented with OpenCV contours',annotationType==='sam2-detection'&&'Main object detected with SAM2 AI bounding box',annotationType==='sam2-segmentation'&&'Objects segmented with SAM2 AI precision masks']})]}):/*#__PURE__*/_jsxs(\"div\",{style:{color:'#dc2626',fontSize:'14px'},children:[\"Error: \",result.error]})]},index))})]})]});}export default Annotate;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}